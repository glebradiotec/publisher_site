{% extends "admin/base.html" %}
{% block title %}Дашборд — CMS{% endblock %}

{% block admin_content %}
<!-- Header -->
<div class="mb-6">
    <h1 class="text-2xl font-display font-bold text-text-main dark:text-white m-0">Дашборд</h1>
    <p class="text-sm text-gray-500 dark:text-gray-400 mt-1 m-0">Обзор контента издательства</p>
</div>

<!-- ===== STAT CARDS ===== -->
<div class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-4 gap-4 mb-6">

    <!-- Журналы -->
    <div class="relative bg-white dark:bg-surface-dark rounded-xl border border-gray-200/80 dark:border-gray-700/50 p-5 overflow-hidden group hover:shadow-soft transition-all">
        <div class="absolute top-0 left-0 right-0 h-[3px] bg-gradient-to-r from-primary to-primary-soft"></div>
        <div class="flex items-center justify-between mb-3">
            <div class="w-9 h-9 rounded-lg bg-primary/10 flex items-center justify-center text-primary">
                <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 15.5A1.5 1.5 0 015.5 14H16"/><path d="M5.5 2H16v16H5.5A1.5 1.5 0 014 16.5v-13A1.5 1.5 0 015.5 2z"/></svg>
            </div>
        </div>
        <div class="text-3xl font-extrabold text-text-main dark:text-white leading-none tracking-tight">{{ stats.journals_total }}</div>
        <div class="text-xs font-semibold uppercase tracking-wider text-gray-400 dark:text-gray-500 mt-1">{{ stats.journals_total|pluralize_ru('журнал', 'журнала', 'журналов') }}</div>
        <div class="mt-3 h-1.5 bg-gray-100 dark:bg-gray-800 rounded-full overflow-hidden">
            <div class="h-full bg-primary rounded-full transition-all duration-700" style="width: {{ (stats.journals_active / stats.journals_total * 100) if stats.journals_total else 0 }}%"></div>
        </div>
        <div class="text-[11px] text-gray-400 dark:text-gray-500 mt-1.5">{{ stats.journals_active }} из {{ stats.journals_total }} активны</div>
    </div>

    <!-- Выпуски -->
    <div class="relative bg-white dark:bg-surface-dark rounded-xl border border-gray-200/80 dark:border-gray-700/50 p-5 overflow-hidden group hover:shadow-soft transition-all">
        <div class="absolute top-0 left-0 right-0 h-[3px] bg-gradient-to-r from-blue-500 to-blue-300"></div>
        <div class="flex items-center justify-between mb-3">
            <div class="w-9 h-9 rounded-lg bg-blue-500/10 flex items-center justify-center text-blue-500">
                <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="14" height="10" rx="2"/><line x1="7" y1="18" x2="13" y2="18"/><line x1="10" y1="14" x2="10" y2="18"/></svg>
            </div>
        </div>
        <div class="text-3xl font-extrabold text-text-main dark:text-white leading-none tracking-tight">{{ stats.issues_total }}</div>
        <div class="text-xs font-semibold uppercase tracking-wider text-gray-400 dark:text-gray-500 mt-1">{{ stats.issues_total|pluralize_ru('выпуск', 'выпуска', 'выпусков') }}</div>
        <div class="mt-3 h-1.5 bg-gray-100 dark:bg-gray-800 rounded-full overflow-hidden">
            <div class="h-full bg-blue-500 rounded-full transition-all duration-700" style="width: {{ (stats.issues_published / stats.issues_total * 100) if stats.issues_total else 0 }}%"></div>
        </div>
        <div class="text-[11px] text-gray-400 dark:text-gray-500 mt-1.5">{{ stats.issues_published }} опубл. · {{ stats.issues_draft }} черн.</div>
    </div>

    <!-- Статьи -->
    <div class="relative bg-white dark:bg-surface-dark rounded-xl border border-gray-200/80 dark:border-gray-700/50 p-5 overflow-hidden group hover:shadow-soft transition-all">
        <div class="absolute top-0 left-0 right-0 h-[3px] bg-gradient-to-r from-purple-500 to-purple-300"></div>
        <div class="flex items-center justify-between mb-3">
            <div class="w-9 h-9 rounded-lg bg-purple-500/10 flex items-center justify-center text-purple-500">
                <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2H6a2 2 0 00-2 2v14a2 2 0 002 2h10a2 2 0 002-2V8z"/><polyline points="12 2 12 8 18 8"/><line x1="14" y1="11" x2="8" y2="11"/><line x1="14" y1="15" x2="8" y2="15"/></svg>
            </div>
        </div>
        <div class="text-3xl font-extrabold text-text-main dark:text-white leading-none tracking-tight">{{ stats.articles_total }}</div>
        <div class="text-xs font-semibold uppercase tracking-wider text-gray-400 dark:text-gray-500 mt-1">{{ stats.articles_total|pluralize_ru('статья', 'статьи', 'статей') }}</div>
        <div class="mt-3 h-1.5 bg-gray-100 dark:bg-gray-800 rounded-full overflow-hidden">
            <div class="h-full bg-purple-500 rounded-full transition-all duration-700" style="width: {{ (stats.articles_with_pdf / stats.articles_total * 100) if stats.articles_total else 0 }}%"></div>
        </div>
        <div class="text-[11px] text-gray-400 dark:text-gray-500 mt-1.5">{{ stats.articles_with_pdf }} с PDF · {{ stats.articles_with_doi }} с DOI</div>
    </div>

    <!-- Пользователи -->
    <div class="relative bg-white dark:bg-surface-dark rounded-xl border border-gray-200/80 dark:border-gray-700/50 p-5 overflow-hidden group hover:shadow-soft transition-all">
        <div class="absolute top-0 left-0 right-0 h-[3px] bg-gradient-to-r from-amber-500 to-amber-300"></div>
        <div class="flex items-center justify-between mb-3">
            <div class="w-9 h-9 rounded-lg bg-amber-500/10 flex items-center justify-center text-amber-500">
                <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 18v-1.5a3 3 0 00-3-3H7a3 3 0 00-3 3V18"/><circle cx="9" cy="7" r="3"/><path d="M18 18v-1.5a3 3 0 00-2-2.83"/><path d="M14 3.17a3 3 0 010 5.66"/></svg>
            </div>
        </div>
        <div class="text-3xl font-extrabold text-text-main dark:text-white leading-none tracking-tight">{{ stats.users_total }}</div>
        <div class="text-xs font-semibold uppercase tracking-wider text-gray-400 dark:text-gray-500 mt-1">{{ stats.users_total|pluralize_ru('пользователь', 'пользователя', 'пользователей') }}</div>
        <div class="mt-3 h-1.5 bg-gray-100 dark:bg-gray-800 rounded-full overflow-hidden">
            <div class="h-full bg-amber-500 rounded-full" style="width: 100%"></div>
        </div>
        <div class="text-[11px] text-gray-400 dark:text-gray-500 mt-1.5">администраторы CMS</div>
    </div>
</div>

<!-- ===== TWO COLUMN LAYOUT ===== -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-5 mb-6">

    <!-- LEFT: Quick actions + Warnings -->
    <div class="space-y-5">

        <!-- Quick actions panel -->
        <div class="bg-white dark:bg-surface-dark rounded-xl border border-gray-200/80 dark:border-gray-700/50 overflow-hidden">
            <div class="flex items-center gap-2 px-5 py-3.5 border-b border-gray-100 dark:border-gray-800 bg-gray-50/50 dark:bg-white/[0.02]">
                <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" class="text-gray-400" stroke-linecap="round" stroke-linejoin="round"><polygon points="10 2 3 12 9 12 8 18 15 8 9 8 10 2"/></svg>
                <span class="text-[13px] font-semibold text-text-main dark:text-white">Быстрые действия</span>
            </div>
            <div class="p-4">
                <div class="grid grid-cols-3 gap-2.5">
                    <a href="{{ url_for('admin_journal_add') }}" class="flex flex-col items-center gap-2 py-4 px-2 rounded-xl bg-primary text-white hover:bg-primary-dark no-underline transition-all hover:shadow-glow hover:-translate-y-0.5">
                        <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                        <span class="text-[12px] font-semibold">Новый журнал</span>
                    </a>
                    <a href="{{ url_for('admin_journals') }}" class="flex flex-col items-center gap-2 py-4 px-2 rounded-xl bg-gray-50 dark:bg-white/5 border border-gray-200/60 dark:border-gray-700/40 text-gray-600 dark:text-gray-300 hover:border-primary/40 hover:text-primary no-underline transition-all hover:-translate-y-0.5">
                        <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 15.5A1.5 1.5 0 015.5 14H16"/><path d="M5.5 2H16v16H5.5A1.5 1.5 0 014 16.5v-13A1.5 1.5 0 015.5 2z"/></svg>
                        <span class="text-[12px] font-semibold">Журналы</span>
                    </a>
                    <a href="{{ url_for('admin_users') }}" class="flex flex-col items-center gap-2 py-4 px-2 rounded-xl bg-gray-50 dark:bg-white/5 border border-gray-200/60 dark:border-gray-700/40 text-gray-600 dark:text-gray-300 hover:border-primary/40 hover:text-primary no-underline transition-all hover:-translate-y-0.5">
                        <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 18v-1.5a3 3 0 00-3-3H7a3 3 0 00-3 3V18"/><circle cx="9" cy="7" r="3"/></svg>
                        <span class="text-[12px] font-semibold">Пользователи</span>
                    </a>
                    <a href="{{ url_for('admin_backups') }}" class="flex flex-col items-center gap-2 py-4 px-2 rounded-xl bg-gray-50 dark:bg-white/5 border border-gray-200/60 dark:border-gray-700/40 text-gray-600 dark:text-gray-300 hover:border-primary/40 hover:text-primary no-underline transition-all hover:-translate-y-0.5">
                        <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 10v3a1 1 0 01-1 1H5a1 1 0 01-1-1v-3"/><polyline points="5 7 9 11 13 7"/><line x1="9" y1="11" x2="9" y2="3"/></svg>
                        <span class="text-[12px] font-semibold">Бэкапы</span>
                    </a>
                    <a href="/" target="_blank" class="flex flex-col items-center gap-2 py-4 px-2 rounded-xl bg-gray-50 dark:bg-white/5 border border-gray-200/60 dark:border-gray-700/40 text-gray-600 dark:text-gray-300 hover:border-primary/40 hover:text-primary no-underline transition-all hover:-translate-y-0.5 col-span-2">
                        <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 9v5a1 1 0 01-1 1H4a1 1 0 01-1-1V7a1 1 0 011-1h5"/><polyline points="10 2 14 2 14 6"/><line x1="7" y1="9" x2="14" y2="2"/></svg>
                        <span class="text-[12px] font-semibold">Открыть сайт</span>
                    </a>
                </div>
            </div>
        </div>

        <!-- Warnings panel -->
        {% if warnings %}
        <div class="bg-white dark:bg-surface-dark rounded-xl border border-gray-200/80 dark:border-gray-700/50 overflow-hidden">
            <div class="flex items-center gap-2 px-5 py-3.5 border-b border-gray-100 dark:border-gray-800 bg-gray-50/50 dark:bg-white/[0.02]">
                <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" class="text-gray-400" stroke-linecap="round" stroke-linejoin="round"><circle cx="8" cy="8" r="7"/><line x1="8" y1="5" x2="8" y2="8"/><line x1="8" y1="11" x2="8.01" y2="11"/></svg>
                <span class="text-[13px] font-semibold text-text-main dark:text-white">Состояние контента</span>
                <span class="ml-auto text-[11px] font-bold bg-primary text-white px-2 py-0.5 rounded-full">{{ warnings|length }}</span>
            </div>
            <div class="divide-y divide-gray-100 dark:divide-gray-800">
                {% for w in warnings %}
                <div class="flex items-center gap-3 px-5 py-3 hover:bg-gray-50/80 dark:hover:bg-white/[0.02] transition-colors">
                    {% if w.type == 'warning' %}
                    <div class="w-2 h-2 rounded-full bg-amber-400 shadow-[0_0_6px_rgba(245,158,11,0.5)] shrink-0"></div>
                    {% else %}
                    <div class="w-2 h-2 rounded-full bg-blue-400 shadow-[0_0_6px_rgba(59,130,246,0.4)] shrink-0"></div>
                    {% endif %}
                    <span class="text-[13px] {{ 'text-text-main dark:text-gray-200' if w.type == 'warning' else 'text-gray-500 dark:text-gray-400' }}">{{ w.message }}</span>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

    </div>

    <!-- RIGHT: Journals -->
    <div>
        <div class="bg-white dark:bg-surface-dark rounded-xl border border-gray-200/80 dark:border-gray-700/50 overflow-hidden">
            <div class="flex items-center gap-2 px-5 py-3.5 border-b border-gray-100 dark:border-gray-800 bg-gray-50/50 dark:bg-white/[0.02]">
                <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" class="text-gray-400" stroke-linecap="round" stroke-linejoin="round"><path d="M4 13.5A1.5 1.5 0 015.5 12H14"/><path d="M5.5 2H14v14H5.5A1.5 1.5 0 014 14.5v-11A1.5 1.5 0 015.5 2z"/></svg>
                <span class="text-[13px] font-semibold text-text-main dark:text-white">Журналы</span>
                <span class="ml-auto text-[11px] font-bold bg-primary text-white px-2 py-0.5 rounded-full">{{ journal_summaries|length }}</span>
            </div>

            {% if journal_summaries %}
            <div class="divide-y divide-gray-100 dark:divide-gray-800 max-h-[480px] overflow-y-auto">
                {% for s in journal_summaries %}
                <a href="{{ url_for('admin_issues', journal_id=s.journal.id) }}" class="block px-5 py-4 hover:bg-gray-50/80 dark:hover:bg-white/[0.02] transition-colors no-underline group">
                    <!-- Name + badge -->
                    <div class="flex items-center gap-2 mb-1">
                        <div class="text-[14px] font-semibold text-text-main dark:text-white truncate flex-1 min-w-0 group-hover:text-primary transition-colors">{{ s.journal.name }}</div>
                        {% if s.journal.is_active %}
                        <span class="shrink-0 text-[10px] font-bold uppercase tracking-wide bg-emerald-500/10 text-emerald-600 dark:text-emerald-400 px-2 py-0.5 rounded-md">Актив.</span>
                        {% else %}
                        <span class="shrink-0 text-[10px] font-bold uppercase tracking-wide bg-gray-100 dark:bg-gray-800 text-gray-400 px-2 py-0.5 rounded-md">Неакт.</span>
                        {% endif %}
                    </div>
                    {% if s.journal.issn %}
                    <div class="text-[11px] text-gray-400 dark:text-gray-500 mb-2.5">ISSN {{ s.journal.issn }}{% if s.journal.eissn %} · eISSN {{ s.journal.eissn }}{% endif %}</div>
                    {% endif %}
                    <!-- Metrics row -->
                    <div class="flex items-baseline gap-5">
                        <div class="flex items-baseline gap-1">
                            <span class="text-lg font-bold text-text-main dark:text-white">{{ s.total_issues }}</span>
                            <span class="text-[11px] text-gray-400">{{ s.total_issues|pluralize_ru('вып.', 'вып.', 'вып.') }}</span>
                        </div>
                        <div class="flex items-baseline gap-1">
                            <span class="text-lg font-bold text-text-main dark:text-white">{{ s.total_articles }}</span>
                            <span class="text-[11px] text-gray-400">{{ s.total_articles|pluralize_ru('ст.', 'ст.', 'ст.') }}</span>
                        </div>
                        <div class="flex items-baseline gap-1">
                            <span class="text-lg font-bold text-emerald-600 dark:text-emerald-400">{{ s.published_issues }}</span>
                            <span class="text-[11px] text-gray-400">опубл.</span>
                        </div>
                    </div>
                    {% if s.latest_issue %}
                    <div class="text-[11px] text-gray-400 mt-2">
                        Посл. выпуск: №{{ s.latest_issue.number }}/{{ s.latest_issue.year }}
                        {% if not s.latest_issue.is_published %}
                        <span class="text-[10px] font-bold bg-gray-100 dark:bg-gray-800 text-gray-400 px-1.5 py-0.5 rounded ml-1">черн.</span>
                        {% endif %}
                    </div>
                    {% endif %}
                </a>
                {% endfor %}
            </div>
            {% else %}
            <div class="px-5 py-12 text-center text-gray-400 dark:text-gray-500 text-sm">
                Нет журналов. <a href="{{ url_for('admin_journal_add') }}" class="text-primary font-semibold">Создать первый</a>
            </div>
            {% endif %}
        </div>
    </div>

</div>

<!-- ===== RECENT ARTICLES ===== -->
{% if recent_articles %}
<div class="bg-white dark:bg-surface-dark rounded-xl border border-gray-200/80 dark:border-gray-700/50 overflow-hidden">
    <div class="flex items-center gap-2 px-5 py-3.5 border-b border-gray-100 dark:border-gray-800 bg-gray-50/50 dark:bg-white/[0.02]">
        <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" class="text-gray-400" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2H6a2 2 0 00-2 2v14a2 2 0 002 2h10a2 2 0 002-2V8z"/><polyline points="12 2 12 8 18 8"/></svg>
        <span class="text-[13px] font-semibold text-text-main dark:text-white">Последние статьи</span>
    </div>
    <div class="divide-y divide-gray-100 dark:divide-gray-800">
        {% for article in recent_articles %}
        <a href="/admin/articles/{{ article.id }}/edit" class="flex items-center gap-4 px-5 py-3 hover:bg-gray-50/80 dark:hover:bg-white/[0.02] transition-colors no-underline group">
            <div class="flex-1 min-w-0">
                <div class="text-[13px] font-medium text-text-main dark:text-gray-200 truncate group-hover:text-primary transition-colors">{{ article.title|truncate(90) }}</div>
                <div class="text-[11px] text-gray-400 dark:text-gray-500 truncate mt-0.5">
                    {% if article.authors_str %}{{ article.authors_str|truncate(50) }} · {% endif %}
                    {% if article.issue and article.issue.journal %}{{ article.issue.journal.name|truncate(30) }} · №{{ article.issue.number }}/{{ article.issue.year }}{% endif %}
                </div>
            </div>
            <div class="flex items-center gap-1.5 shrink-0">
                {% if article.pdf_file %}
                <span class="text-[10px] font-bold uppercase tracking-wide bg-emerald-500/10 text-emerald-600 dark:text-emerald-400 px-2 py-0.5 rounded-md">PDF</span>
                {% else %}
                <span class="text-[10px] font-bold uppercase tracking-wide bg-red-500/10 text-red-500 dark:text-red-400 px-2 py-0.5 rounded-md">Нет PDF</span>
                {% endif %}
                {% if article.is_published %}
                <span class="text-[10px] font-bold uppercase tracking-wide bg-emerald-500/10 text-emerald-600 dark:text-emerald-400 px-2 py-0.5 rounded-md">Опубл.</span>
                {% else %}
                <span class="text-[10px] font-bold uppercase tracking-wide bg-gray-100 dark:bg-gray-800 text-gray-400 px-2 py-0.5 rounded-md">Черн.</span>
                {% endif %}
            </div>
        </a>
        {% endfor %}
    </div>
</div>
{% endif %}

{% endblock %}

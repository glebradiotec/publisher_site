{% extends "admin/base.html" %}
{% block title %}Пользователи — CMS{% endblock %}

{% block admin_content %}
<div class="page-header" style="display: flex; justify-content: space-between; align-items: center;">
    <h1>Пользователи</h1>
    <button class="btn btn-primary" onclick="document.getElementById('addUserForm').style.display = 'block'">+ Добавить</button>
</div>

<!-- Форма добавления -->
<div id="addUserForm" class="card" style="display: none; margin-bottom: 24px; padding: 20px;">
    <h3 style="margin: 0 0 16px 0; font-size: 16px;">Новый пользователь</h3>
    <form onsubmit="addUser(event)">
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 12px; margin-bottom: 12px;">
            <input type="text" id="new_username" class="form-control" placeholder="Логин" required>
            <input type="text" id="new_display_name" class="form-control" placeholder="Имя" required>
            <input type="password" id="new_password" class="form-control" placeholder="Пароль" required>
            <select id="new_role" class="form-control">
                <option value="editor">Редактор</option>
                <option value="admin">Админ</option>
            </select>
        </div>
        <button type="submit" class="btn btn-primary btn-sm">Создать</button>
        <button type="button" class="btn btn-secondary btn-sm" onclick="document.getElementById('addUserForm').style.display = 'none'">Отмена</button>
    </form>
</div>

<table class="data-table">
    <thead>
        <tr>
            <th>Логин</th>
            <th>Имя</th>
            <th>Роль</th>
            <th>Действия</th>
        </tr>
    </thead>
    <tbody>
        {% for user in users %}
        <tr id="user-{{ user.id }}">
            <td>{{ user.username }}</td>
            <td>{{ user.display_name }}</td>
            <td>
                {% if user.is_admin %}
                <span class="badge-published">Админ</span>
                {% else %}
                <span class="badge-draft">Редактор</span>
                {% endif %}
            </td>
            <td>
                {% if user.id != current_user.id %}
                <button class="btn btn-sm btn-danger" onclick="deleteUser({{ user.id }})">Удалить</button>
                {% else %}
                <span style="font-size: 13px; color: var(--color-fg-muted);">Это вы</span>
                {% endif %}
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<script>
function addUser(e) {
    e.preventDefault();
    var formData = new FormData();
    formData.append('username', document.getElementById('new_username').value);
    formData.append('display_name', document.getElementById('new_display_name').value);
    formData.append('password', document.getElementById('new_password').value);
    formData.append('role', document.getElementById('new_role').value);

    fetch('/admin/users/add', { method: 'POST', body: formData, credentials: 'same-origin' })
    .then(function(r) { return r.json(); })
    .then(function(data) {
        if (data.success) {
            showToast('Пользователь создан', 'success');
            setTimeout(function() { location.reload(); }, 500);
        } else {
            showToast(data.error || 'Ошибка', 'error');
        }
    });
}

function deleteUser(userId) {
    if (!confirm('Удалить пользователя?')) return;
    fetch('/admin/users/' + userId + '/delete', { method: 'POST', credentials: 'same-origin' })
    .then(function(r) { return r.json(); })
    .then(function(data) {
        if (data.success) {
            document.getElementById('user-' + userId).remove();
            showToast('Пользователь удалён', 'success');
        } else {
            showToast(data.error || 'Ошибка', 'error');
        }
    });
}
</script>
{% endblock %}

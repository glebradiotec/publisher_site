{% extends "base.html" %}
{% block title %}Издательство — Научные журналы{% endblock %}

{% block content %}

{# ====== Color/icon sets for journal cards ====== #}
{% set card_icons = ['water_drop', 'eco', 'terminal', 'psychology', 'biotech', 'science'] %}
{% set card_bg_classes = ['teal', 'cyan', 'blue', 'sky', 'emerald', 'violet'] %}

<!-- Search Bar -->
<section class="pt-8 pb-4">
    <div class="max-w-[1200px] mx-auto px-4 sm:px-6 lg:px-8">
        <div class="relative max-w-2xl mx-auto group">
            <div class="absolute -inset-1 bg-gradient-to-r from-primary via-secondary to-accent rounded-2xl blur-lg opacity-40 group-hover:opacity-60 transition duration-500"></div>
            <form action="/search" method="GET" class="relative flex items-center bg-white [data-theme=dark]:bg-surface-dark rounded-2xl shadow-soft overflow-hidden p-2 ring-1 ring-black/5">
                <div class="pl-4 text-primary">
                    <span class="material-symbols-outlined text-[28px]">search</span>
                </div>
                <input name="q" class="w-full border-none bg-transparent px-4 py-4 text-lg text-text-main [data-theme=dark]:text-white placeholder-text-muted/60 focus:ring-0 focus:outline-none font-medium" placeholder="Поиск по статьям, авторам..." type="text">
                <button type="submit" class="hidden sm:flex items-center gap-2 rounded-xl bg-primary px-8 py-3 text-base font-bold text-white shadow-lg shadow-primary/30 hover:bg-ocean-blue hover:scale-105 transition-all duration-300 border-0 cursor-pointer">
                    Поиск
                </button>
            </form>
        </div>
    </div>
</section>

<!-- =============================================
     STATS BAR
     ============================================= -->
{% if stats and (stats.journals > 0 or stats.articles > 0) %}
<section class="stats-bar py-8">
    <div class="max-w-[1200px] mx-auto px-4 sm:px-6 lg:px-8">
        <div class="bg-white/40 [data-theme=dark]:bg-surface-dark/40 backdrop-blur-lg rounded-3xl p-8 border border-white/60 [data-theme=dark]:border-white/5 shadow-sm">
            <div class="grid grid-cols-2 gap-8 md:grid-cols-4 text-center">
                <div class="flex flex-col items-center gap-1 group">
                    <span class="stat-value text-4xl font-display font-bold text-text-main [data-theme=dark]:text-white group-hover:text-primary transition-colors">{{ stats.journals }}</span>
                    <span class="text-sm font-bold text-text-muted uppercase tracking-wider">{{ stats.journals|pluralize_ru('Журнал', 'Журнала', 'Журналов') }}</span>
                </div>
                <div class="flex flex-col items-center gap-1 group">
                    <span class="stat-value text-4xl font-display font-bold text-text-main [data-theme=dark]:text-white group-hover:text-accent transition-colors">{{ stats.issues }}</span>
                    <span class="text-sm font-bold text-text-muted uppercase tracking-wider">{{ stats.issues|pluralize_ru('Выпуск', 'Выпуска', 'Выпусков') }}</span>
                </div>
                <div class="flex flex-col items-center gap-1 group">
                    <span class="stat-value text-4xl font-display font-bold text-text-main [data-theme=dark]:text-white group-hover:text-secondary transition-colors">{{ stats.articles }}</span>
                    <span class="text-sm font-bold text-text-muted uppercase tracking-wider">{{ stats.articles|pluralize_ru('Статья', 'Статьи', 'Статей') }}</span>
                </div>
                <div class="flex flex-col items-center gap-1 group">
                    <span class="text-4xl font-display font-bold text-text-main [data-theme=dark]:text-white group-hover:text-teal-500 transition-colors">20+</span>
                    <span class="text-sm font-bold text-text-muted uppercase tracking-wider">Лет работы</span>
                </div>
            </div>
        </div>
    </div>
</section>
{% endif %}

<!-- =============================================
     CURRENT ISSUE HIGHLIGHT
     ============================================= -->
{% if latest_issue %}
<section class="py-16">
    <div class="max-w-[1200px] mx-auto px-4 sm:px-6 lg:px-8">
        <div class="relative rounded-3xl overflow-hidden bg-white [data-theme=dark]:bg-surface-dark shadow-soft transition-all duration-500 hover:shadow-xl border border-teal-100 [data-theme=dark]:border-gray-800">
            <div class="absolute top-0 right-0 w-full h-full bg-gradient-to-bl from-soft-blue/50 via-transparent to-soft-teal/30 [data-theme=dark]:from-primary/10 [data-theme=dark]:to-accent/5 pointer-events-none"></div>
            <div class="relative z-10 p-8 md:p-12">
                <div class="grid md:grid-cols-12 gap-10 items-center">
                    <!-- Cover -->
                    <div class="md:col-span-5 lg:col-span-4 relative group">
                        <div class="absolute -inset-2 bg-gradient-to-tr from-cyan-400 to-primary rounded-2xl blur-lg opacity-20 group-hover:opacity-40 transition duration-500"></div>
                        <a href="/journal/{{ latest_issue.journal.slug }}/issue/{{ latest_issue.id }}" class="block no-underline">
                            <div class="relative aspect-[3/4] w-full max-w-[320px] mx-auto md:mx-0 rounded-2xl overflow-hidden shadow-2xl transform group-hover:scale-[1.02] transition-transform duration-500 ring-4 ring-white [data-theme=dark]:ring-surface-dark">
                                {% if latest_issue.cover_image %}
                                <img alt="{{ latest_issue.journal.name }}" class="w-full h-full object-cover"
                                     src="{{ url_for('static', filename='uploads/covers/' + latest_issue.cover_image) }}">
                                {% elif latest_issue.journal.cover_image %}
                                <img alt="{{ latest_issue.journal.name }}" class="w-full h-full object-cover"
                                     src="{{ url_for('static', filename='uploads/covers/' + latest_issue.journal.cover_image) }}">
                                {% else %}
                                <div class="w-full h-full bg-gradient-to-br from-primary via-teal-500 to-accent flex items-center justify-center">
                                    <span class="material-symbols-outlined text-[80px] text-white/40">menu_book</span>
                                </div>
                                {% endif %}
                                <div class="absolute top-4 right-4 z-20">
                                    <span class="inline-flex items-center gap-1 px-3 py-1.5 bg-white/90 [data-theme=dark]:bg-black/80 backdrop-blur text-text-main [data-theme=dark]:text-white text-xs font-bold rounded-lg shadow-sm">
                                        <span class="w-2 h-2 rounded-full bg-teal-500 animate-pulse"></span>
                                        Новый выпуск
                                    </span>
                                </div>
                            </div>
                        </a>
                    </div>

                    <!-- Details -->
                    <div class="md:col-span-7 lg:col-span-8">
                        <div class="inline-flex items-center gap-2 px-3 py-1 rounded-lg bg-teal-50 [data-theme=dark]:bg-teal-900/30 text-primary [data-theme=dark]:text-teal-300 text-sm font-bold mb-4">
                            <span class="material-symbols-outlined text-[18px]">star</span>
                            Текущий выпуск
                        </div>
                        <h2 class="font-display text-4xl md:text-5xl font-bold text-text-main [data-theme=dark]:text-white mb-3 m-0">{{ latest_issue.journal.name }}</h2>
                        <p class="text-xl font-medium text-text-muted [data-theme=dark]:text-gray-300 mb-8 flex items-center gap-3 m-0 flex-wrap">
                            <span class="bg-teal-50 [data-theme=dark]:bg-gray-800 text-teal-700 [data-theme=dark]:text-teal-200 px-3 py-1 rounded-md text-sm">
                                №{{ latest_issue.number }}{% if latest_issue.volume %}, т. {{ latest_issue.volume }}{% endif %} / {{ latest_issue.year }}
                            </span>
                            {% if latest_issue.publication_date %}
                            <span class="text-sm opacity-70">{{ latest_issue.publication_date }}</span>
                            {% endif %}
                        </p>

                        {% set published_articles = latest_issue.articles|selectattr('is_published')|list %}
                        {% if published_articles %}
                        <div class="bg-background-light [data-theme=dark]:bg-background-dark/50 rounded-2xl p-6 mb-8 border border-teal-100 [data-theme=dark]:border-gray-800/50 relative">
                            <h3 class="text-xs font-bold text-text-muted uppercase tracking-wider mb-4 m-0">Статьи выпуска <span class="font-normal opacity-60">({{ published_articles|length }})</span></h3>
                            <div id="issue-articles-scroll" class="space-y-3 overflow-y-auto pr-1" style="max-height: 320px; scrollbar-width: thin; scrollbar-color: #99f6e4 transparent;">
                                {% for article in published_articles %}
                                <a class="flex items-start gap-4 p-3 rounded-xl hover:bg-white [data-theme=dark]:hover:bg-surface-dark transition-colors group/item no-underline" href="/article/{{ article.id }}">
                                    <div class="mt-1 w-8 h-8 rounded-lg {% if loop.index0 % 2 == 0 %}bg-cyan-100 [data-theme=dark]:bg-cyan-900/50{% else %}bg-teal-100 [data-theme=dark]:bg-teal-900/50{% endif %} flex items-center justify-center {% if loop.index0 % 2 == 0 %}text-primary{% else %}text-accent{% endif %} font-bold text-sm shrink-0">{{ '%02d'|format(loop.index) }}</div>
                                    <div class="min-w-0">
                                        <h4 class="font-bold text-text-main [data-theme=dark]:text-white group-hover/item:text-primary transition-colors text-lg m-0" style="display: -webkit-box; -webkit-line-clamp: 1; -webkit-box-orient: vertical; overflow: hidden;">{{ article.title }}</h4>
                                        {% if article.authors_str %}
                                        <p class="text-sm text-text-muted m-0 truncate">{{ article.authors_str }}</p>
                                        {% endif %}
                                    </div>
                                </a>
                                {% endfor %}
                            </div>
                            <!-- Fade at bottom when scrollable -->
                            <div id="issue-articles-fade" class="pointer-events-none absolute bottom-0 left-0 right-0 h-16 rounded-b-2xl bg-gradient-to-t from-background-light [data-theme=dark]:from-background-dark/50 to-transparent" style="display:none;"></div>
                        </div>
                        {% endif %}

                        <div class="flex flex-wrap gap-4">
                            <a href="/journal/{{ latest_issue.journal.slug }}/issue/{{ latest_issue.id }}" class="flex items-center gap-3 bg-primary text-white hover:bg-ocean-blue px-8 py-4 rounded-xl font-bold text-sm transition-all shadow-lg hover:shadow-xl hover:-translate-y-1 no-underline">
                                <span>Читать выпуск</span>
                                <span class="material-symbols-outlined text-[20px]">arrow_forward</span>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
{% endif %}

<!-- =============================================
     JOURNALS CAROUSEL
     ============================================= -->
{% if journals %}
<section class="py-16 overflow-hidden">
    <div class="max-w-[1400px] mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex items-end justify-between mb-12 px-2">
            <div>
                <h2 class="font-display text-4xl font-bold tracking-tight text-text-main [data-theme=dark]:text-white m-0">Наши журналы</h2>
                <p class="mt-2 text-xl text-text-muted [data-theme=dark]:text-gray-400 font-medium m-0">Откройте для себя актуальные научные исследования.</p>
            </div>
            {% if journals|length > 3 %}
            <div class="hidden sm:flex items-center gap-3">
                <button onclick="document.getElementById('journals-carousel').scrollBy({left: -370, behavior: 'smooth'})" class="flex items-center justify-center w-12 h-12 rounded-full border border-gray-200 [data-theme=dark]:border-gray-700 hover:border-primary hover:text-primary hover:bg-white [data-theme=dark]:hover:bg-surface-dark transition-all bg-transparent cursor-pointer">
                    <span class="material-symbols-outlined">arrow_back</span>
                </button>
                <button onclick="document.getElementById('journals-carousel').scrollBy({left: 370, behavior: 'smooth'})" class="flex items-center justify-center w-12 h-12 rounded-full bg-primary text-white shadow-lg shadow-primary/30 hover:bg-ocean-blue transition-all transform hover:scale-105 cursor-pointer border-0">
                    <span class="material-symbols-outlined">arrow_forward</span>
                </button>
            </div>
            {% endif %}
        </div>

        <div id="journals-carousel" class="carousel-container flex gap-6 px-4 pb-12">
            {% for journal in journals %}
            {% set ci = loop.index0 % 6 %}
            {% set bg_color = card_bg_classes[ci] %}
            <a href="/journal/{{ journal.slug }}" class="carousel-item flex-none w-[320px] no-underline" style="color: inherit;">
                <div class="journal-card h-full flex flex-col rounded-[2rem] bg-white [data-theme=dark]:bg-surface-dark border border-gray-100 [data-theme=dark]:border-gray-800 p-2">
                    <!-- Card header with icon -->
                    <div class="h-48 rounded-[1.5rem] bg-{{ bg_color }}-50 [data-theme=dark]:bg-{{ bg_color }}-900/20 relative overflow-hidden flex items-center justify-center group">
                        {% if journal.cover_image %}
                        <img src="{{ url_for('static', filename='uploads/covers/' + journal.cover_image) }}" alt="{{ journal.name }}" class="absolute inset-0 w-full h-full object-cover">
                        {% else %}
                        <div class="absolute inset-0 bg-[radial-gradient(circle_at_center,_var(--tw-gradient-stops))] from-{{ bg_color }}-200/50 to-transparent opacity-50"></div>
                        <span class="material-symbols-outlined text-[80px] text-{{ bg_color }}-400/80 group-hover:scale-110 group-hover:rotate-6 transition-all duration-500">{{ card_icons[ci] }}</span>
                        {% endif %}
                    </div>
                    <!-- Card body -->
                    <div class="p-6 flex flex-col flex-grow">
                        <div class="flex justify-between items-center mb-2">
                            {% if journal.issn %}
                            <span class="text-xs font-bold uppercase tracking-wider text-{{ bg_color }}-600 bg-{{ bg_color }}-50 [data-theme=dark]:bg-{{ bg_color }}-900/30 px-2 py-1 rounded-md">ISSN {{ journal.issn }}</span>
                            {% else %}
                            <span></span>
                            {% endif %}
                        </div>
                        <h3 class="font-display text-xl font-bold text-text-main [data-theme=dark]:text-white mb-2 m-0 leading-tight" style="display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">{{ journal.name }}</h3>
                        {% if journal.description %}
                        <p class="text-sm text-text-muted [data-theme=dark]:text-gray-400 line-clamp-2 mb-4 leading-relaxed m-0" style="display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">{{ journal.description }}</p>
                        {% endif %}
                        <div class="mt-auto">
                            <span class="w-full py-3 rounded-xl bg-gray-50 [data-theme=dark]:bg-gray-800 text-text-main [data-theme=dark]:text-white font-bold text-sm hover:bg-{{ bg_color }}-500 hover:text-white transition-colors flex items-center justify-center">
                                Открыть журнал
                            </span>
                        </div>
                    </div>
                </div>
            </a>
            {% endfor %}
        </div>
    </div>
</section>
{% endif %}

<!-- =============================================
     FEATURED ARTICLE
     ============================================= -->
{% if featured_article %}
<section class="py-24 relative overflow-hidden bg-gradient-to-br from-soft-teal/30 to-soft-blue/30 [data-theme=dark]:from-surface-dark [data-theme=dark]:to-background-dark">
    <div class="max-w-[1400px] mx-auto px-4 sm:px-6 lg:px-8 relative z-10">
        <div class="grid lg:grid-cols-2 gap-16 items-center">
            <!-- Text -->
            <div class="order-2 lg:order-1">
                <span class="inline-block px-4 py-1.5 rounded-full bg-white [data-theme=dark]:bg-white/10 text-primary font-bold tracking-wide uppercase text-xs mb-6 shadow-sm">Избранная публикация</span>
                <h2 class="font-display text-4xl md:text-5xl font-extrabold text-text-main [data-theme=dark]:text-white mb-6 leading-tight m-0">
                    {{ featured_article.title }}
                </h2>
                {% if featured_article.abstract %}
                <p class="text-xl text-text-muted [data-theme=dark]:text-gray-300 mb-8 leading-relaxed font-medium m-0" style="display: -webkit-box; -webkit-line-clamp: 4; -webkit-box-orient: vertical; overflow: hidden;">
                    {{ featured_article.abstract }}
                </p>
                {% endif %}

                <div class="flex items-center gap-6 mb-10 p-4 bg-white/50 [data-theme=dark]:bg-surface-dark/50 rounded-2xl backdrop-blur-sm w-fit border border-white/40 flex-wrap">
                    {% if featured_article.authors_str %}
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-primary/10 flex items-center justify-center text-primary">
                            <span class="material-symbols-outlined">person</span>
                        </div>
                        <div>
                            <p class="text-xs uppercase text-text-muted font-bold m-0">Авторы</p>
                            <p class="font-bold text-text-main [data-theme=dark]:text-white m-0" style="display: -webkit-box; -webkit-line-clamp: 1; -webkit-box-orient: vertical; overflow: hidden; max-width: 200px;">{{ featured_article.authors_str }}</p>
                        </div>
                    </div>
                    {% endif %}
                    {% if featured_article.issue and featured_article.issue.journal %}
                    <div class="w-px h-10 bg-gray-200 [data-theme=dark]:bg-gray-700 hidden sm:block"></div>
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-accent/10 flex items-center justify-center text-accent">
                            <span class="material-symbols-outlined">menu_book</span>
                        </div>
                        <div>
                            <p class="text-xs uppercase text-text-muted font-bold m-0">Журнал</p>
                            <p class="font-bold text-text-main [data-theme=dark]:text-white m-0">{{ featured_article.issue.journal.name }}</p>
                        </div>
                    </div>
                    {% endif %}
                </div>

                <div class="flex gap-4">
                    <a href="/article/{{ featured_article.id }}" class="flex items-center justify-center rounded-xl bg-primary text-white hover:bg-ocean-blue px-8 py-4 text-sm font-bold shadow-lg hover:shadow-xl hover:-translate-y-1 transition-all no-underline">
                        Читать статью
                    </a>
                    {% if featured_article.issue %}
                    <a href="/journal/{{ featured_article.issue.journal.slug }}/issue/{{ featured_article.issue.id }}" class="flex items-center justify-center rounded-xl bg-white [data-theme=dark]:bg-surface-dark border-2 border-transparent text-text-main [data-theme=dark]:text-white px-8 py-4 text-sm font-bold hover:border-primary hover:text-primary transition-all shadow-sm no-underline">
                        Весь выпуск
                    </a>
                    {% endif %}
                </div>
            </div>

            <!-- Image -->
            <div class="order-1 lg:order-2 flex justify-center lg:justify-end">
                <div class="relative group">
                    <div class="absolute -inset-4 bg-gradient-to-r from-primary via-teal-500 to-accent rounded-[2rem] blur-xl opacity-40 group-hover:opacity-60 transition duration-500 animate-pulse"></div>
                    <div class="relative rounded-2xl shadow-2xl overflow-hidden transform group-hover:scale-[1.03] group-hover:rotate-1 transition duration-500 max-w-[340px] aspect-[2/3] ring-1 ring-white/20">
                        {% if featured_article.issue and featured_article.issue.journal and featured_article.issue.journal.cover_image %}
                        <img alt="{{ featured_article.issue.journal.name }}" class="w-full h-full object-cover"
                             src="{{ url_for('static', filename='uploads/covers/' + featured_article.issue.journal.cover_image) }}">
                        {% else %}
                        <div class="w-full h-full bg-gradient-to-br from-primary via-teal-600 to-accent flex items-center justify-center">
                            <div class="text-center p-8">
                                <span class="material-symbols-outlined text-[60px] text-white/30 mb-4">article</span>
                                <div class="text-white/80 font-bold text-lg leading-tight">{{ featured_article.issue.journal.name if featured_article.issue and featured_article.issue.journal else 'Научная статья' }}</div>
                            </div>
                        </div>
                        {% endif %}
                        <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/80 via-black/40 to-transparent p-8">
                            <span class="inline-block px-3 py-1 bg-accent text-white text-xs font-bold rounded-full mb-2">Избранное</span>
                            <p class="text-white font-bold text-lg leading-tight m-0">Рекомендация редакции</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
{% endif %}

<!-- =============================================
     CTA SECTION
     ============================================= -->
<section class="py-20 relative overflow-hidden text-center">
    <div class="absolute inset-0 bg-primary/5 [data-theme=dark]:bg-primary/10"></div>
    <div class="blob-shape bg-primary/20 w-[600px] h-[600px] rounded-full top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 blur-[100px]"></div>
    <div class="relative z-10 max-w-3xl mx-auto px-4">
        <div class="inline-flex items-center justify-center w-16 h-16 rounded-2xl bg-white shadow-lg mb-6 text-primary rotate-12">
            <span class="material-symbols-outlined text-3xl">send</span>
        </div>
        <h2 class="font-display text-4xl md:text-5xl font-bold text-text-main [data-theme=dark]:text-white mb-6 m-0">Готовы опубликовать?</h2>
        <p class="text-text-muted [data-theme=dark]:text-gray-300 text-xl mb-10 max-w-xl mx-auto m-0">
            Присоединяйтесь к авторам, которые доверяют нашему издательству быструю и прозрачную публикацию.
        </p>
        <div class="flex flex-col sm:flex-row gap-4 justify-center">
            <a href="/search" class="rounded-xl bg-primary text-white px-8 py-4 text-base font-bold hover:bg-ocean-blue hover:shadow-lg transition-all transform hover:-translate-y-1 no-underline inline-flex items-center justify-center">
                Найти публикации
            </a>
            <a href="/journals" class="rounded-xl bg-white [data-theme=dark]:bg-surface-dark border-2 border-gray-100 [data-theme=dark]:border-gray-700 text-text-main [data-theme=dark]:text-white px-8 py-4 text-base font-bold hover:border-primary hover:text-primary transition-all no-underline inline-flex items-center justify-center">
                Каталог журналов
            </a>
        </div>
    </div>
</section>

<!-- =============================================
     EMPTY STATE
     ============================================= -->
{% if not journals and not recent_issues %}
<section class="py-24 text-center">
    <div class="max-w-md mx-auto">
        <span class="material-symbols-outlined text-[64px] text-text-muted/30 mb-4">library_books</span>
        <h3 class="text-xl font-bold text-text-main [data-theme=dark]:text-white mb-2 m-0">Контент скоро появится</h3>
        <p class="text-text-muted m-0">Журналы и статьи пока не добавлены. Загляните позже!</p>
    </div>
</section>
{% endif %}

{% endblock %}

{% block scripts %}
<script>
(function(){
    var el = document.getElementById('issue-articles-scroll');
    var fade = document.getElementById('issue-articles-fade');
    if (!el || !fade) return;
    function checkFade() {
        var canScroll = el.scrollHeight > el.clientHeight;
        var atBottom = el.scrollTop + el.clientHeight >= el.scrollHeight - 8;
        fade.style.display = (canScroll && !atBottom) ? '' : 'none';
    }
    checkFade();
    el.addEventListener('scroll', checkFade);
    window.addEventListener('resize', checkFade);
})();
</script>
{% endblock %}

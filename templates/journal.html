{% extends "base.html" %}
{% block title %}{{ journal.name }} — Издательство{% endblock %}

{% block content %}
<style>
    /* Year accordion toggle */
    .year-group .year-issues { display: none; }
    .year-group.open .year-issues { display: block; }
    .year-group .year-chevron { transition: transform 0.3s; }
    .year-group.open .year-chevron { transform: rotate(90deg); }

    /* Issue row hover */
    .issue-row { transition: background 0.2s; }
    .issue-row:hover { background: rgba(13, 148, 136, 0.03); }
    [data-theme="dark"] .issue-row:hover { background: rgba(255,255,255,0.03); }
</style>
<section class="max-w-[1200px] mx-auto px-4 sm:px-6 lg:px-8 pt-8 pb-24">

    <!-- ===== HEADER ===== -->
    <div class="flex flex-col md:flex-row md:items-end justify-between gap-6 mb-8">
        <div>
            <div class="flex items-center gap-2 mb-3">
                <a class="text-sm text-text-muted hover:text-primary transition-colors no-underline" href="/">Главная</a>
                <span class="text-text-muted/50">/</span>
                <a class="text-sm text-text-muted hover:text-primary transition-colors no-underline" href="/journals">Журналы</a>
                <span class="text-text-muted/50">/</span>
                <span class="text-sm font-semibold text-primary">{{ journal.name }}</span>
            </div>
            <h1 class="font-display text-4xl md:text-5xl font-bold text-text-main [data-theme=dark]:text-white mb-2 m-0">{{ journal.name }}</h1>
            {% if journal.issn %}
            <p class="text-text-muted [data-theme=dark]:text-gray-400 font-mono text-sm m-0">
                ISSN: {{ journal.issn }}{% if journal.eissn %} · eISSN: {{ journal.eissn }}{% endif %}
            </p>
            {% endif %}
        </div>
    </div>

    <!-- ===== INFO GRID: sidebar + about/board ===== -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-12">

        <!-- LEFT SIDEBAR: cover, stats, meta -->
        <div class="lg:col-span-1">
            <div class="glass-panel rounded-2xl p-6 shadow-soft h-full flex flex-col items-center text-center relative overflow-hidden">
                <div class="absolute top-0 right-0 w-40 h-40 bg-gradient-to-bl from-primary/10 to-transparent rounded-bl-full pointer-events-none"></div>

                <!-- Cover or icon -->
                {% if journal.cover_image %}
                <div class="w-40 rounded-xl overflow-hidden mb-6 mt-4" style="aspect-ratio:3/4; mask-image:radial-gradient(ellipse 85% 80% at center, black 60%, transparent 100%); -webkit-mask-image:radial-gradient(ellipse 85% 80% at center, black 60%, transparent 100%);">
                    <img src="{{ url_for('static', filename='uploads/covers/' + journal.cover_image) }}" alt="{{ journal.name }}" class="w-full h-full object-cover">
                </div>
                {% else %}
                <div class="w-32 h-32 rounded-2xl bg-gradient-to-br from-teal-50 to-white [data-theme=dark]:from-gray-800 [data-theme=dark]:to-surface-dark shadow-inner border border-teal-50 [data-theme=dark]:border-gray-700 flex items-center justify-center mb-6 mt-4">
                    <span class="material-symbols-outlined text-6xl text-transparent bg-clip-text bg-gradient-to-br from-primary to-accent">menu_book</span>
                </div>
                {% endif %}

                <!-- Stats -->
                <div class="w-full grid grid-cols-2 gap-4 mt-4">
                    <div class="bg-white/50 [data-theme=dark]:bg-surface-dark/50 p-4 rounded-xl border border-white/60 [data-theme=dark]:border-white/5">
                        <span class="block text-2xl font-bold text-text-main [data-theme=dark]:text-white">{{ total_issues }}</span>
                        <span class="text-xs text-text-muted uppercase tracking-wider font-semibold">{{ total_issues|pluralize_ru('Выпуск', 'Выпуска', 'Выпусков') }}</span>
                    </div>
                    <div class="bg-white/50 [data-theme=dark]:bg-surface-dark/50 p-4 rounded-xl border border-white/60 [data-theme=dark]:border-white/5">
                        <span class="block text-2xl font-bold text-text-main [data-theme=dark]:text-white">{{ total_articles }}</span>
                        <span class="text-xs text-text-muted uppercase tracking-wider font-semibold">{{ total_articles|pluralize_ru('Статья', 'Статьи', 'Статей') }}</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- RIGHT: About + Editorial Board -->
        <div class="lg:col-span-2 flex flex-col gap-6">
            <!-- About -->
            {% if journal.description or journal.aims_scope %}
            <div class="bg-white [data-theme=dark]:bg-surface-dark rounded-2xl shadow-sm border border-gray-100 [data-theme=dark]:border-gray-800 p-8">
                <h3 class="text-xl font-display font-bold text-text-main [data-theme=dark]:text-white mb-4 flex items-center gap-2 m-0">
                    <span class="material-symbols-outlined text-primary">info</span> О журнале
                </h3>
                {% if journal.description %}
                <p class="text-text-muted [data-theme=dark]:text-gray-300 leading-relaxed mb-4 m-0">{{ journal.description }}</p>
                {% endif %}
                {% if journal.aims_scope %}
                <div class="text-text-muted [data-theme=dark]:text-gray-300 leading-relaxed">{{ journal.aims_scope|safe }}</div>
                {% endif %}
            </div>
            {% endif %}

            <!-- Editorial Board -->
            {% if journal.editorial_board %}
            <div class="bg-white [data-theme=dark]:bg-surface-dark rounded-2xl shadow-sm border border-gray-100 [data-theme=dark]:border-gray-800 p-8 flex-grow">
                <h3 class="text-xl font-display font-bold text-text-main [data-theme=dark]:text-white mb-4 flex items-center gap-2 m-0">
                    <span class="material-symbols-outlined text-accent">groups</span> Редколлегия
                </h3>
                <div class="text-text-muted [data-theme=dark]:text-gray-300 leading-relaxed">{{ journal.editorial_board|safe }}</div>
            </div>
            {% endif %}

            <!-- Submission info -->
            {% if journal.submission_info %}
            <div class="bg-white [data-theme=dark]:bg-surface-dark rounded-2xl shadow-sm border border-gray-100 [data-theme=dark]:border-gray-800 p-8">
                <h3 class="text-xl font-display font-bold text-text-main [data-theme=dark]:text-white mb-4 flex items-center gap-2 m-0">
                    <span class="material-symbols-outlined text-secondary">upload_file</span> Для авторов
                </h3>
                <div class="text-text-muted [data-theme=dark]:text-gray-300 leading-relaxed">{{ journal.submission_info|safe }}</div>
            </div>
            {% endif %}

            <!-- Fallback if no extra info -->
            {% if not journal.description and not journal.aims_scope and not journal.editorial_board and not journal.submission_info %}
            <div class="bg-white [data-theme=dark]:bg-surface-dark rounded-2xl shadow-sm border border-gray-100 [data-theme=dark]:border-gray-800 p-8">
                <h3 class="text-xl font-display font-bold text-text-main [data-theme=dark]:text-white mb-4 flex items-center gap-2 m-0">
                    <span class="material-symbols-outlined text-primary">info</span> О журнале
                </h3>
                <p class="text-text-muted m-0">Информация о журнале пока не добавлена.</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- ===== LATEST ISSUE HIGHLIGHT ===== -->
    {% if latest_issue %}
    {% set pub_articles = latest_issue.articles|selectattr('is_published')|list %}
    <div class="mb-10">
        <div class="flex items-center justify-between mb-8">
            <h2 class="text-2xl font-display font-bold text-text-main [data-theme=dark]:text-white m-0">Архив выпусков</h2>
        </div>

        <div class="bg-gradient-to-r from-teal-500 to-emerald-600 rounded-2xl p-1 mb-10 shadow-lg" style="box-shadow: 0 10px 30px -5px rgba(13, 148, 136, 0.2);">
            <div class="bg-white [data-theme=dark]:bg-surface-dark rounded-xl p-6 md:p-8 flex flex-col md:flex-row items-center gap-8 relative overflow-hidden">
                <div class="absolute top-0 right-0 w-64 h-64 bg-teal-50 [data-theme=dark]:bg-teal-900/10 rounded-full blur-3xl -mr-16 -mt-16 pointer-events-none"></div>

                <!-- Mini cover -->
                <div class="shrink-0 relative z-10">
                    <div class="w-24 h-32 md:w-32 md:h-40 bg-white shadow-xl border border-gray-100 rounded-lg flex flex-col items-center justify-center text-center p-2">
                        {% if latest_issue.cover_image or journal.cover_image %}
                        <img src="{{ url_for('static', filename='uploads/covers/' + (latest_issue.cover_image or journal.cover_image)) }}" alt="" class="w-full h-full object-cover rounded">
                        {% else %}
                        {% if latest_issue.volume %}
                        <span class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-1">Т. {{ latest_issue.volume }}</span>
                        {% endif %}
                        <span class="text-3xl font-display font-bold text-text-main">№{{ latest_issue.number }}</span>
                        <span class="text-sm font-medium text-primary mt-1">{{ latest_issue.year }}</span>
                        {% endif %}
                    </div>
                </div>

                <!-- Details -->
                <div class="flex-grow z-10 text-center md:text-left">
                    <div class="flex flex-col md:flex-row md:items-center gap-3 mb-3 justify-center md:justify-start">
                        <span class="px-3 py-1 bg-green-100 text-green-700 text-xs font-bold uppercase rounded-full w-fit mx-auto md:mx-0">Последний выпуск</span>
                        {% if latest_issue.publication_date %}
                        <span class="text-text-muted text-sm font-medium">{{ latest_issue.publication_date }}</span>
                        {% endif %}
                    </div>
                    <h3 class="text-2xl md:text-3xl font-display font-bold text-text-main [data-theme=dark]:text-white mb-2 m-0">
                        №{{ latest_issue.number }}{% if latest_issue.volume %}, т. {{ latest_issue.volume }}{% endif %} / {{ latest_issue.year }}
                    </h3>
                    {% if latest_issue.description %}
                    <p class="text-text-muted [data-theme=dark]:text-gray-400 mb-6 max-w-2xl m-0">{{ latest_issue.description }}</p>
                    {% elif pub_articles %}
                    <p class="text-text-muted [data-theme=dark]:text-gray-400 mb-6 max-w-2xl m-0">
                        {{ pub_articles|length }} {{ pub_articles|length|pluralize_ru('статья', 'статьи', 'статей') }}
                    </p>
                    {% endif %}
                    <div class="flex flex-wrap gap-4 justify-center md:justify-start">
                        <a href="/journal/{{ journal.slug }}/issue/{{ latest_issue.id }}" class="flex items-center gap-2 px-5 py-2.5 bg-primary text-white rounded-lg font-semibold hover:bg-primary-dark transition-colors shadow-md no-underline" style="box-shadow: 0 4px 12px rgba(13,148,136,0.2);">
                            <span class="material-symbols-outlined text-sm">visibility</span> Читать выпуск
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <div class="flex items-center justify-between mb-8">
        <h2 class="text-2xl font-display font-bold text-text-main [data-theme=dark]:text-white m-0">Архив выпусков</h2>
    </div>
    {% endif %}

    <!-- ===== ISSUES TABLE BY YEAR (accordion) ===== -->
    {% if years %}
    <div class="bg-white [data-theme=dark]:bg-surface-dark rounded-2xl shadow-sm border border-gray-100 [data-theme=dark]:border-gray-800 overflow-hidden">
        <!-- Table header -->
        <div class="grid grid-cols-12 gap-4 p-5 bg-gray-50/50 [data-theme=dark]:bg-white/5 border-b border-gray-100 [data-theme=dark]:border-gray-800 font-semibold text-sm text-text-muted">
            <div class="col-span-6 md:col-span-5 pl-2">Выпуск</div>
            <div class="col-span-3 md:col-span-2 text-center">Статус</div>
            <div class="col-span-3 md:col-span-3 hidden md:block">Статьи</div>
            <div class="col-span-3 md:col-span-2 text-right pr-2">Действия</div>
        </div>

        {% for year, year_issues in years.items() %}
        <div class="year-group border-b border-gray-100 [data-theme=dark]:border-gray-800">

            <!-- Year header -->
            <div class="year-header px-6 py-3 flex items-center gap-2 cursor-pointer hover:bg-gray-100/50 [data-theme=dark]:hover:bg-white/5 transition-colors bg-gray-50 [data-theme=dark]:bg-white/5">
                <span class="material-symbols-outlined year-chevron text-text-muted">chevron_right</span>
                <span class="font-bold text-lg text-text-muted">{{ year }}</span>
                <span class="text-xs text-text-muted font-normal ml-2">({{ year_issues|length }} {{ year_issues|length|pluralize_ru('выпуск', 'выпуска', 'выпусков') }})</span>
            </div>

            <!-- Issues in this year -->
            <div class="year-issues divide-y divide-gray-50 [data-theme=dark]:divide-gray-800/50">
                {% for issue in year_issues %}
                {% set pub_count = issue.articles|selectattr('is_published')|list|length %}
                <div class="issue-row grid grid-cols-12 gap-4 p-5 items-center group">
                    <div class="col-span-6 md:col-span-5 flex items-center gap-4">
                        <div class="w-10 h-10 rounded-lg bg-teal-50 [data-theme=dark]:bg-teal-900/20 text-teal-600 flex items-center justify-center shrink-0">
                            <span class="material-symbols-outlined">book</span>
                        </div>
                        <div>
                            <a href="/journal/{{ journal.slug }}/issue/{{ issue.id }}" class="no-underline">
                                <h4 class="font-bold text-text-main [data-theme=dark]:text-white text-base group-hover:text-primary transition-colors m-0">
                                    №{{ issue.number }}{% if issue.volume %}, т. {{ issue.volume }}{% endif %}
                                </h4>
                            </a>
                            <p class="text-xs text-text-muted m-0">
                                {% if issue.publication_date %}{{ issue.publication_date }}{% else %}{{ issue.year }}{% endif %}
                            </p>
                        </div>
                    </div>
                    <div class="col-span-3 md:col-span-2 flex justify-center">
                        <span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-medium bg-emerald-100 text-emerald-800 [data-theme=dark]:bg-emerald-900/30 [data-theme=dark]:text-emerald-400">
                            <span class="w-1.5 h-1.5 rounded-full bg-emerald-500"></span> Опубликован
                        </span>
                    </div>
                    <div class="col-span-3 md:col-span-3 hidden md:flex items-center text-sm text-text-muted">
                        <span class="material-symbols-outlined text-[16px] mr-2">description</span>
                        {{ pub_count }} {{ pub_count|pluralize_ru('статья', 'статьи', 'статей') }}
                    </div>
                    <div class="col-span-3 md:col-span-2 flex justify-end gap-2 pr-2">
                        <a href="/journal/{{ journal.slug }}/issue/{{ issue.id }}" class="p-2 text-text-muted hover:text-accent hover:bg-accent/10 rounded-lg transition-colors no-underline" title="Читать">
                            <span class="material-symbols-outlined text-[20px]">arrow_forward</span>
                        </a>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="bg-white [data-theme=dark]:bg-surface-dark rounded-2xl shadow-sm border border-gray-100 [data-theme=dark]:border-gray-800 p-12 text-center">
        <span class="material-symbols-outlined text-[48px] text-text-muted/30 mb-4">library_books</span>
        <h3 class="text-lg font-bold text-text-main [data-theme=dark]:text-white mb-2 m-0">Выпуски пока не опубликованы</h3>
        <p class="text-text-muted m-0">Загляните позже!</p>
    </div>
    {% endif %}

</section>

<script>
/* Year accordion — inside content block so SPA router can execute it */
document.querySelectorAll('.year-header').forEach(function(header) {
    header.addEventListener('click', function() {
        this.parentElement.classList.toggle('open');
    });
});
/* Auto-open the first (most recent) year */
(function() {
    var firstGroup = document.querySelector('.year-group');
    if (firstGroup) firstGroup.classList.add('open');
})();
</script>
{% endblock %}
